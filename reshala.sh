#!/bin/bash
# ============================================================ #
# ==      –ò–ù–°–¢–†–£–ú–ï–ù–¢ ¬´–†–ï–®–ê–õ–ê¬ª v2.0 - Skynet Framework       == #
# ============================================================ #
#
# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞. –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç ‚Äî –ø—Ä–æ—Ä–∞–±. –û–Ω —Ç–æ–ª—å–∫–æ –æ—Ç–¥–∞—ë—Ç –∫–æ–º–∞–Ω–¥—ã
# –º–æ–¥—É–ª—è–º –∏ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
#
set -uo pipefail

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–¥–µ –ª–µ–∂–∏—Ç –≤—Å—è –Ω–∞—à–∞ –∫—É—Ö–Ω—è
readonly SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
readonly VERSION="v2.0" # –í–µ—Ä—Å–∏—è —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞

# ============================================================ #
#              –ü–û–î–ì–û–¢–û–í–ö–ê –ò –ó–ê–ì–†–£–ó–ö–ê –ö–û–ú–ü–û–ù–ï–ù–¢–û–í               #
# ============================================================ #

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é. –ï—Å–ª–∏ –µ—ë –Ω–µ—Ç - –≤—Å—ë, –ø–∏–∑–¥–µ—Ü, –ø—Ä–∏–µ—Ö–∞–ª–∏.
if [ -f "${SCRIPT_DIR}/config/reshala.conf" ]; then
    source "${SCRIPT_DIR}/config/reshala.conf"
else
    echo "[FATAL ERROR] Configuration file config/reshala.conf not found."
    exit 1
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã. –ë–µ–∑ –Ω–∏—Ö –∫–∞–∫ –±–µ–∑ —Ä—É–∫.
if [ -f "${SCRIPT_DIR}/modules/common.sh" ]; then
    source "${SCRIPT_DIR}/modules/common.sh"
else
    echo "[FATAL ERROR] Common tools module modules/common.sh not found."
    exit 1
fi

# ============================================================ #
#                     –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê                           #
# ============================================================ #

# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫ –∏ –∑–∞–ø—É—Å–∫–∞—Ç–æ—Ä –º–æ–¥—É–ª–µ–π
run_module() {
    local module_name="$1"
    shift # –£–±–∏—Ä–∞–µ–º –∏–º—è –º–æ–¥—É–ª—è, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –µ—ë –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    local module_path="${SCRIPT_DIR}/modules/${module_name}.sh"

    if [ -f "$module_path" ]; then
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª—å –∏ –≤—ã–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å –µ—ë –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
        source "$module_path"
        "$@" # "$@" —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –µ—ë –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    else
        log "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –º–æ–¥—É–ª—å '${module_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω."
        printf_error "–ú–æ–¥—É–ª—å '${module_name}' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞."
    fi
}

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, –∫–æ—Ç–æ—Ä–æ–µ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
show_main_menu() {
    trap 'printf "\r\033[K%b" "${C_RED}üõë –ö—É–¥–∞ —Å–æ–±—Ä–∞–ª—Å—è? –ñ–º–∏ [q], —á—Ç–æ–±—ã –≤—ã–π—Ç–∏!${C_RESET}"; sleep 1' SIGINT

    while true; do
        run_module dashboard show
        
        if [[ ${UPDATE_AVAILABLE:-0} -eq 1 ]]; then
            printf "\n%b‚ÄºÔ∏è –î–û–°–¢–£–ü–ù–û –û–ë–ù–û–í–õ–ï–ù–ò–ï! %s -> %s ‚ÄºÔ∏è%b\n" \
                   "${C_BOLD}${C_RED}" "${VERSION}" "${LATEST_VERSION}" "${C_RESET}"
        fi

        printf "\n%s\n\n" "–ß—ë –¥–µ–ª–∞—Ç—å –±—É–¥–µ–º, –±–æ—Å—Å?"

        if [ "${SKYNET_MODE:-0}" -ne 1 ]; then
            printf "   [0] üåê %b\n" "–£–ü–†–ê–í–õ–ï–ù–ò–ï –§–õ–û–¢–û–ú ${C_WHITE}(Skynet Mode)${C_RESET}"
            echo "   ---------------------------------------------------"
        fi

        printf "   [1] üîß %b\n" "–û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï –°–ï–†–í–ï–†–ê ${C_GRAY}(Apt, –°–µ—Ç—å, –¢–µ—Å—Ç—ã)${C_RESET}"
        printf "   [2] üìú %b\n" "–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò –õ–û–ì–ò ${C_GRAY}(Docker, –ñ—É—Ä–Ω–∞–ª—ã)${C_RESET}"
        printf "   [3] üíø %b\n" "–£–°–¢–ê–ù–û–í–ò–¢–¨ REMNAWAVE ${C_GRAY}(—Å–∫–æ—Ä–æ...)${C_RESET}"

        if [[ ${UPDATE_AVAILABLE:-0} -eq 1 ]]; then
            echo ""
            printf "   %b[u] ‚ÄºÔ∏è –û–ë–ù–û–í–ò–¢–¨ –†–ï–®–ê–õ–£ ‚ÄºÔ∏è%b\n" "${C_BOLD}${C_YELLOW}" "${C_RESET}"
        fi
        echo ""

        if [ "${SKYNET_MODE:-0}" -eq 1 ]; then
            printf "   [w] üîß %b\n" "–£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ò–î–ñ–ï–¢–ê–ú–ò" 
            printf "   [d] üóëÔ∏è  –°–Ω–µ—Å—Ç–∏ –†–µ—à–∞–ª—É (–£–¥–∞–ª–µ–Ω–∏–µ)\n"
            printf "   [q] üîô %b\n" "${C_CYAN}–í–ï–†–ù–£–¢–¨–°–Ø –í –¶–£–ü${C_RESET}"
        else
            printf "   [d] üóëÔ∏è  –°–Ω–µ—Å—Ç–∏ –†–µ—à–∞–ª—É (–£–¥–∞–ª–µ–Ω–∏–µ)\n"
            printf "   [q] üö™ –°–≤–∞–ª–∏—Ç—å (–í—ã—Ö–æ–¥)\n"
        fi
        echo "------------------------------------------------------"

        local choice; read -r -p "–¢–≤–æ–π –≤—ã–±–æ—Ä, –±–æ—Å—Å: " choice || continue

        case "$choice" in
            0) if [ "${SKYNET_MODE:-0}" -ne 1 ]; then run_module skynet show_fleet_menu; else printf_error "–¢—ã —É–∂–µ –≤ –º–∞—Ç—Ä–∏—Ü–µ."; fi ;;
            1) run_module local_care show_maintenance_menu ;;
            2) run_module diagnostics show_diagnostics_menu ;;
            3) printf_warning "–ú–æ–¥—É–ª—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ." && sleep 2 ;;
            u|U) if [[ ${UPDATE_AVAILABLE:-0} -eq 1 ]]; then run_module self_update run_update; else printf_error "–û–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ—Ç."; fi ;;
            w|W) run_module widget_manager show_widgets_menu ;;
            d|D) run_module self_update uninstall_script ;;
            q|Q)
                trap - SIGINT
                if [ "${SKYNET_MODE:-0}" -eq 1 ]; then exit 0; else echo "–ë—ã–ª —Ä–∞–¥ –ø–æ–º–æ—á—å. –ù–µ –æ–±–æ—Å—Ä–∏—Å—å. ü•É"; break; fi
                ;;
            *) printf_error "–ù–µ—Ç —Ç–∞–∫–æ–≥–æ –ø—É–Ω–∫—Ç–∞." ;;
        esac
    done
}

# ============================================================ #
#                       –¢–û–ß–ö–ê –í–•–û–î–ê                            #
# ============================================================ #
main() {
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–≥–µ—Ä
    init_logger

    # –ï—Å–ª–∏ –º—ã –Ω–µ root, –¥–∞–ª—å–Ω–µ–π—à–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–µ–Ω
    if [[ $EUID -ne 0 ]]; then
        printf_error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç –∏–º–µ–Ω–∏ root –∏–ª–∏ —á–µ—Ä–µ–∑ sudo."
        exit 1
    fi

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã `install` - —ç—Ç–æ –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π
    if [[ "${1:-}" == "install" ]]; then
        # –õ–æ–≥–∏–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±—É–¥–µ—Ç –≤ self_update.sh, –Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫
        # –ú—ã —É–∂–µ –ø–æ–¥ root, —Ç–∞–∫ —á—Ç–æ –º–æ–∂–µ–º –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞—Ç—å
        source "${SCRIPT_DIR}/modules/self_update.sh" && install_script
        
        # –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –ü–†–û–í–ï–†–Ø–ï–ú –∏ –°–¢–ê–í–ò–ú sudo, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç.
        # –≠—Ç–æ –æ–¥–Ω–∞ –∏–∑ –ø–µ—Ä–≤—ã—Ö –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—É—é –†–µ—à–∞–ª–∞ –¥–µ–ª–∞–µ—Ç –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞.
        if ! command -v sudo &>/dev/null; then
            if command -v apt-get &>/dev/null; then
                printf_info "–ö–æ–º–∞–Ω–¥–∞ 'sudo' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
                apt-get update -qq >/dev/null
                apt-get install -y -qq sudo
                printf_ok "'sudo' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ."
            fi
        fi
        exit 0
    fi

    log "–ó–∞–ø—É—Å–∫ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ –†–µ—à–∞–ª–∞ ${VERSION}"

    # –ü–µ—Ä–≤–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ñ–æ–Ω–µ
    run_module self_update check_for_updates &

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    show_main_menu
}

# –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å—é —ç—Ç—É —à–∞—Ä–º–∞–Ω–∫—É
main "$@"