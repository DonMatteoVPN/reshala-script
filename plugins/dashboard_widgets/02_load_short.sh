#!/bin/bash
# TITLE: ÐŸÑƒÐ»ÑŒÑ ÑÐµÑ€Ð²ÐµÑ€Ð° (Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°)
# Ð’Ð¸Ð´Ð¶ÐµÑ‚ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ (load average) Ð¸ Ð´Ð°Ñ‘Ñ‚ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²ÑƒÑŽ Ð¾Ñ†ÐµÐ½ÐºÑƒ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ.
#
# ÐšÐÐš ÐÐÐ¡Ð¢Ð ÐžÐ˜Ð¢Ð¬ ÐŸÐžÐ” Ð¡Ð•Ð‘Ð¯:
#   - Ð¥Ð¾Ñ‡ÐµÑˆÑŒ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ñ‚ÐµÐºÑÑ‚ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð² â€” Ð¿Ñ€Ð°Ð²ÑŒ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð² Ð±Ð»Ð¾ÐºÐµ case Ð½Ð¸Ð¶Ðµ.
#   - Ð¥Ð¾Ñ‡ÐµÑˆÑŒ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ð¾Ñ€Ð¾Ð³Ð¸ (ÐºÐ¾Ð³Ð´Ð° ÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð²ÑÑ‘ Ð¿Ð»Ð¾Ñ…Ð¾) â€” Ð¿Ð¾Ð¼ÐµÐ½ÑÐ¹ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ THRESH_WARN/THRESH_BAD.
#   - Ð›ÐµÐ¹Ð±Ð» "ÐŸÑƒÐ»ÑŒÑ ÑÐµÑ€Ð²ÐµÑ€Ð°  :" Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð¾ Ñ‡Ñ‚Ð¾ ÑƒÐ³Ð¾Ð´Ð½Ð¾, Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð´Ð²Ð¾ÐµÑ‚Ð¾Ñ‡Ð¸Ðµ.

CORES=$(nproc 2>/dev/null || echo "?")
# Ð‘ÐµÑ€Ñ‘Ð¼ 1â€‘Ð¼Ð¸Ð½ÑƒÑ‚Ð½Ñ‹Ð¹ load average. Ð•ÑÐ»Ð¸ uptime Ð½Ðµ Ð¾Ñ‚Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» â€” Ð¾ÑÑ‚Ð°Ð²Ð¸Ð¼ Ð¿ÑƒÑÑ‚Ð¾.
LOAD_RAW=$(uptime 2>/dev/null | awk -F'load average:' '{print $2}' | cut -d',' -f1 | xargs)

if [ -z "$LOAD_RAW" ]; then
  echo "ÐŸÑƒÐ»ÑŒÑ ÑÐµÑ€Ð²ÐµÑ€Ð°  : Ð½ÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
  exit 0
fi

# ÐŸÐ¾Ñ€Ð¾Ð³Ð¾Ð²Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ñ‡Ð¸ÑÐ»Ð° ÑÐ´ÐµÑ€
THRESH_WARN=0.7   # Ð´Ð¾ 70% Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð½Ð° ÑÐ´Ñ€Ð¾ â€” Ð½Ð¾Ñ€Ð¼
THRESH_BAD=1.0    # Ð±Ð¾Ð»ÑŒÑˆÐµ 100% Ð½Ð° ÑÐ´Ñ€Ð¾ â€” ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð´Ñ‹Ñ…Ð°ÐµÑ‚ÑÑ

# Ð•ÑÐ»Ð¸ Ð·Ð½Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ´ÐµÑ€ â€” ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½ÑƒÑŽ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ
if [[ "$CORES" =~ ^[0-9]+$ ]]; then
  REL_LOAD=$(awk -v l="$LOAD_RAW" -v c="$CORES" 'c>0 {printf "%.2f", l/c}')
else
  REL_LOAD="$LOAD_RAW"
fi

STATUS="" 
if [[ "$CORES" =~ ^[0-9]+$ ]]; then
  cmp=$(awk -v x="$REL_LOAD" -v t="$THRESH_WARN" 'BEGIN{print (x<t)?"lt":"ge"}')
  if [ "$cmp" = "lt" ]; then
    STATUS="ÑÐ¿Ð¾ÐºÐ¾ÐµÐ½"
  else
    cmp2=$(awk -v x="$REL_LOAD" -v t="$THRESH_BAD" 'BEGIN{print (x<t)?"lt":"ge"}')
    if [ "$cmp2" = "lt" ]; then
      STATUS="Ð¿Ð¾Ñ‚ÐµÐµÑ‚, Ð½Ð¾ Ð´ÐµÑ€Ð¶Ð¸Ñ‚ÑÑ"
    else
      STATUS="Ð¾Ñ€Ñ‘Ñ‚: ÐŸÐžÐœÐžÐ“Ð˜Ð¢Ð• ðŸ§¯"
    fi
  fi
else
  STATUS="Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°: $LOAD_RAW"
fi

echo "ÐŸÑƒÐ»ÑŒÑ ÑÐµÑ€Ð²ÐµÑ€Ð°  : $STATUS (load: $LOAD_RAW, ÑÐ´ÐµÑ€: $CORES)"
