#!/bin/bash
# ============================================================ #
# ==             REMNAWAVE: –ü–ï–†–ï–£–°–¢–ê–ù–û–í–ö–ê –°–¢–ï–ö–ê              == #
# ============================================================ #
# –ü–æ–¥–º–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏. –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞,
# –ø–æ–∑–∂–µ –±—É–¥–µ—Ç –¥–æ–ø–∏—Å–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –ª–æ–≥–∏–∫–∞.

[[ "${BASH_SOURCE[0]}" == "${0}" ]] && exit 1

show_remnawave_reinstall_menu() {
    enable_graceful_ctrlc
    while true; do
        clear
        menu_header "–ü–ï–†–ï–£–°–¢–ê–ù–û–í–ö–ê –ü–ê–ù–ï–õ–ò/–ù–û–î–´ REMNAWAVE"
        echo
        echo "   1) –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ü–ê–ù–ï–õ–¨ –∏ –ù–û–î–£ –Ω–∞ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä"
        echo "   2) –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¢–û–õ–¨–ö–û –ü–ê–ù–ï–õ–¨"
        echo "   3) –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¢–û–õ–¨–ö–û –õ–û–ö–ê–õ–¨–ù–£–Æ –ù–û–î–£"
        echo
        echo "   [b] üîô –ù–∞–∑–∞–¥"
        echo "------------------------------------------------------"

        local choice
        choice=$(safe_read "–¢–≤–æ–π –≤—ã–±–æ—Ä: " "") || break

        case "$choice" in
            1)
                echo
                info "–≠—Ç–æ—Ç —Ä–µ–∂–∏–º –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å–≤—è–∑–∫—É –ü–ê–ù–ï–õ–¨+–ù–û–î–ê –Ω–∞ –≠–¢–û–ú —Å–µ—Ä–≤–µ—Ä–µ."
                info "Docker-–¥–∞–Ω–Ω—ã–µ (–±–∞–∑–∞, Redis) –æ–±—ã—á–Ω–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ docker volume'–∞—Ö –∏ –ø—Ä–∏ down –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è."
                info "–Ø –æ—Å—Ç–∞–Ω–æ–≤–ª—é —Ç–µ–∫—É—â–∏–π —Å—Ç—ç–∫ –∏ –∑–∞–ø—É—â—É –º–∞—Å—Ç–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–Ω–µ–ª—å+–Ω–æ–¥–∞ –∑–∞–Ω–æ–≤–æ."
                echo
                if [[ ! -d /opt/remnawave ]]; then
                    err "–ù–µ –Ω–∞–π–¥–µ–Ω –∫–∞—Ç–∞–ª–æ–≥ /opt/remnawave. –ü–æ—Ö–æ–∂–µ, –ø–∞–Ω–µ–ª—å –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä."
                    wait_for_enter || true
                    ;; 
                else
                    local confirm
                    confirm=$(safe_read "–¢–æ—á–Ω–æ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ü–ê–ù–ï–õ–¨+–ù–û–î–£ –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ? (YES/–Ω–µ—Ç): " "–Ω–µ—Ç")
                    if [[ "$confirm" != "YES" ]]; then
                        info "–û—Ç–º–µ–Ω—è—é –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞–Ω–µ–ª—å+–Ω–æ–¥–∞."
                        wait_for_enter || true
                        ;;
                    fi

                    info "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ç–µ–∫—É—â–∏–π —Å—Ç—ç–∫ Remnawave (–ø–∞–Ω–µ–ª—å+–Ω–æ–¥–∞) –≤ /opt/remnawave..."
                    ( cd /opt/remnawave && run_cmd docker compose down ) || \
                        warn "docker compose down –≤ /opt/remnawave –æ—Ç—Ä–∞–±–æ—Ç–∞–ª —Å –æ—à–∏–±–∫–æ–π. –ü—Ä–æ–¥–æ–ª–∂–∞—é, –Ω–æ –ø—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤—Ä—É—á–Ω—É—é."

                    local wipe
                    wipe=$(safe_read "–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ñ–∞–π–ª—ã /opt/remnawave –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π? (y/N): " "n")
                    if [[ "$wipe" == "y" || "$wipe" == "Y" ]]; then
                        info "–ß–∏—â—É /opt/remnawave (docker volume'—ã –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ —Ç—Ä–æ–≥–∞—é)."
                        run_cmd rm -rf /opt/remnawave || warn "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å /opt/remnawave –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞."
                    fi

                    info "–ó–∞–ø—É—Å–∫–∞—é –º–∞—Å—Ç–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ü–ê–ù–ï–õ–¨+–ù–û–î–ê –∑–∞–Ω–æ–≤–æ..."
                    run_module remnawave_panel_node _remna_install_panel_and_node_wizard
                fi
                ;;
            2)
                echo
                info "–≠—Ç–æ—Ç —Ä–µ–∂–∏–º –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç –¢–û–õ–¨–ö–û –ü–ê–ù–ï–õ–¨ Remnawave –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ."
                info "–ö–∞—Ç–∞–ª–æ–≥ /opt/remnawave –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω, –Ω–æ–¥—ã/Skynet —ç—Ç–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç."
                echo
                if [[ ! -d /opt/remnawave ]]; then
                    warn "–ö–∞—Ç–∞–ª–æ–≥ /opt/remnawave –ø–æ–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –≠—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ —á–∏—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–Ω–µ–ª–∏."
                fi

                local confirm_p
                confirm_p=$(safe_read "–¢–æ—á–Ω–æ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¢–û–õ–¨–ö–û –ü–ê–ù–ï–õ–¨ –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ? (YES/–Ω–µ—Ç): " "–Ω–µ—Ç")
                if [[ "$confirm_p" != "YES" ]]; then
                    info "–û—Ç–º–µ–Ω—è—é –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞–Ω–µ–ª–∏."
                    wait_for_enter || true
                    ;;
                fi

                if [[ -d /opt/remnawave ]]; then
                    info "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ç–µ–∫—É—â–∏–π –ø–∞–Ω–µ–ª—å–Ω—ã–π —Å—Ç—ç–∫ –≤ /opt/remnawave..."
                    ( cd /opt/remnawave && run_cmd docker compose down ) || \
                        warn "docker compose down –≤ /opt/remnawave –æ—Ç—Ä–∞–±–æ—Ç–∞–ª —Å –æ—à–∏–±–∫–æ–π. –ü—Ä–æ–¥–æ–ª–∂–∞—é, –Ω–æ –ø—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤—Ä—É—á–Ω—É—é."
                fi

                local wipe_p
                wipe_p=$(safe_read "–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ñ–∞–π–ª—ã /opt/remnawave –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–∞–Ω–µ–ª–∏? (y/N): " "n")
                if [[ "$wipe_p" == "y" || "$wipe_p" == "Y" ]]; then
                    info "–ß–∏—â—É /opt/remnawave (docker volume'—ã –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ —Ç—Ä–æ–≥–∞—é)."
                    run_cmd rm -rf /opt/remnawave || warn "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å /opt/remnawave –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞."
                fi

                info "–ó–∞–ø—É—Å–∫–∞—é –º–∞—Å—Ç–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¢–û–õ–¨–ö–û –ü–ê–ù–ï–õ–ò –∑–∞–Ω–æ–≤–æ..."
                run_module remnawave_panel _remna_panel_install_wizard
                ;;
            3)
                echo
                info "–≠—Ç–æ—Ç —Ä–µ–∂–∏–º –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç –¢–û–õ–¨–ö–û –õ–û–ö–ê–õ–¨–ù–£–Æ –ù–û–î–£ Remnawave –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ."
                info "–ü–∞–Ω–µ–ª—å –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å /opt/remnanode."
                echo
                if [[ ! -d /opt/remnanode ]]; then
                    warn "–ö–∞—Ç–∞–ª–æ–≥ /opt/remnanode –ø–æ–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –≠—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ —á–∏—Å—Ç–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –Ω–æ–¥—ã."
                fi

                local confirm_n
                confirm_n=$(safe_read "–¢–æ—á–Ω–æ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¢–û–õ–¨–ö–û –õ–û–ö–ê–õ–¨–ù–£–Æ –ù–û–î–£ –Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ? (YES/–Ω–µ—Ç): " "–Ω–µ—Ç")
                if [[ "$confirm_n" != "YES" ]]; then
                    info "–û—Ç–º–µ–Ω—è—é –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫—É –ª–æ–∫–∞–ª—å–Ω–æ–π –Ω–æ–¥—ã."
                    wait_for_enter || true
                    ;;
                fi

                if [[ -d /opt/remnanode ]]; then
                    info "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ç–µ–∫—É—â–∏–π —Å—Ç—ç–∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –Ω–æ–¥—ã –≤ /opt/remnanode..."
                    ( cd /opt/remnanode && run_cmd docker compose down ) || \
                        warn "docker compose down –≤ /opt/remnanode –æ—Ç—Ä–∞–±–æ—Ç–∞–ª —Å –æ—à–∏–±–∫–æ–π. –ü—Ä–æ–¥–æ–ª–∂–∞—é, –Ω–æ –ø—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤—Ä—É—á–Ω—É—é."
                fi

                local wipe_n
                wipe_n=$(safe_read "–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Ñ–∞–π–ª—ã /opt/remnanode –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–¥—ã? (y/N): " "n")
                if [[ "$wipe_n" == "y" || "$wipe_n" == "Y" ]]; then
                    info "–ß–∏—â—É /opt/remnanode (docker volume'—ã –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ —Ç—Ä–æ–≥–∞—é)."
                    run_cmd rm -rf /opt/remnanode || warn "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å /opt/remnanode –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞."
                fi

                info "–ó–∞–ø—É—Å–∫–∞—é –º–∞—Å—Ç–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¢–û–õ–¨–ö–û –ù–û–î–´ –∑–∞–Ω–æ–≤–æ..."
                run_module remnawave_node _remna_node_install_local_wizard
                ;;
            [bB])
                break
                ;;
            *)
                err "–ù–µ—Ç —Ç–∞–∫–æ–≥–æ –ø—É–Ω–∫—Ç–∞, —Å–º–æ—Ç—Ä–∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ, –±–æ—Å—Å."
                ;;
        esac
    done
    disable_graceful_ctrlc
}
